name: Build RPM
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: 
  push:
    branches: [ master ]
    paths-ignore: [ ".github/workflows/release.yml" ]
    
jobs:
  Build:
    runs-on: self-hosted
    env:
      SPEC: experiment.spec
    container:
      image: ghcr.io/fincreg/rockylinux:8-rpmbuild
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v3

      - name: Create rpmbuild structure
        run: mkdir -p $GITHUB_WORKSPACE/{SPECS,SOURCES,BUILD,BUILDROOT,RPMS,SRPMS}

      - name: Install dependencies
        run: dnf builddep -y $GITHUB_WORKSPACE/$SPEC --enablerepo powertools

      - name: Build RPM/SRPM packages
        run: >
              rpmbuild -ba
              --define "_topdir $GITHUB_WORKSPACE/rpmbuild"
              --define "_builddir $GITHUB_WORKSPACE"
              $GITHUB_WORKSPACE/$SPEC

      - name: Show build packages
        run: tree $GITHUB_WORKSPACE/{RPMS/SRPMS}
        
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          path: |
            rpmbuild/RPMS/x86_64/**
            rpmbuild/SRPMS/**



